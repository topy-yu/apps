<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººèµ„é‡‘å¤´å¯¸ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0284c7; --danger: #e11d48; --bg: #f1f5f9; }
        body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: var(--bg); margin: 20px; color: #1e293b; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        .total-banner { background: #0ea5e9; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 1.2rem; }
        
        /* è¡¨å•å¸ƒå±€ */
        .form-group { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; background: #f8fafc; padding: 15px; border-radius: 8px; align-items: flex-end; }
        .input-box { display: flex; flex-direction: column; gap: 5px; }
        input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; transition: border 0.2s; position: relative; }
        input:focus { border-color: var(--primary); }
        input:disabled { background-color: #f1f5f9; color: #64748b; cursor: not-allowed; }
        input[list]::-webkit-calendar-picker-indicator { cursor: pointer; }
        
        /* datalistæ ·å¼å¢å¼ºç”¨æˆ·ä½“éªŒ */
        #accTag { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23cbd5e1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,9 12,15 18,9"/></svg>'); background-repeat: no-repeat; background-position: right 10px center; padding-right: 35px; }
        
        button { cursor: pointer; padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; transition: 0.2s; }
        .btn-save { background: var(--primary); color: white; }
        .btn-export { background: #475569; color: white; }
        .btn-import { background: #94a3b8; color: white; }

        /* è¡¨æ ¼ä¸å›¾è¡¨ */
        .main-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; text-align: left; padding: 12px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .amt { font-family: 'Courier New', Courier, monospace; font-weight: bold; text-align: right; }
        
        .btn-edit { color: #d97706; background: none; padding: 4px; }
        .btn-del { color: var(--danger); background: none; padding: 4px; }
        .tag-pill { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’° èµ„é‡‘èµ„äº§æ¦‚è§ˆ <span id="clock" style="font-size: 0.9rem; font-weight: normal; color: #64748b;"></span></h2>

    <div class="total-banner">
        æ€»èµ„äº§é¢åº¦: <span id="totalAmount">Â¥ 0.00</span>
    </div>

    <div class="form-group">
        <div class="input-box">
            <label>è´¦æˆ·/èµ„é‡‘åç§°</label>
            <input type="text" id="accName" placeholder="ä¾‹å¦‚ï¼šæ‹›å•†é“¶è¡Œå‚¨è“„">
        </div>
        <div class="input-box">
            <label>é‡‘é¢ (Â¥)</label>
            <input type="number" id="accBalance" step="0.01" placeholder="0.00" oninput="handleBalanceInput()">
        </div>
        <div class="input-box">
            <label>å•ä»· (Â¥) <small style="color: #94a3b8;">å¯é€‰</small></label>
            <input type="number" id="accPrice" step="0.01" placeholder="0.00" oninput="calculateFromPriceAndQuantity()">
        </div>
        <div class="input-box">
            <label>æ•°é‡ <small style="color: #94a3b8;">å¯é€‰</small></label>
            <input type="number" id="accQuantity" step="0.001" placeholder="1" oninput="calculateFromPriceAndQuantity()">
        </div>
        <div class="input-box">
            <label>åˆ†ç±» (Tag) <small style="color: #94a3b8;">â–¼ å¯é€‰æ‹©å·²æœ‰æˆ–è¾“å…¥æ–°æ ‡ç­¾</small></label>
            <input type="text" id="accTag" placeholder="ä¾‹å¦‚ï¼šç°é‡‘ã€ç†è´¢" list="tagList" autocomplete="off">
            <datalist id="tagList">
                <!-- åŠ¨æ€å¡«å……å·²æœ‰æ ‡ç­¾ -->
            </datalist>
        </div>
        <input type="hidden" id="editId">
        <button onclick="saveData()" class="btn-save" id="saveBtn">ä¿å­˜è®°å½•</button>
        <button onclick="exportJSON()" class="btn-export">å¯¼å‡ºå¤‡ä»½</button>
        <small style="color: #64748b; margin-left: 5px;">ğŸ“ å¯é€‰æ‹©ä¿å­˜ä½ç½®ï¼ŒåŒ…å«å•ä»·æ•°é‡</small>
        <input type="file" id="fileInput" style="display:none" onchange="importJSON(this)">
        <button onclick="document.getElementById('fileInput').click()" class="btn-import">å¯¼å…¥</button>
        <small style="color: #dc2626; margin-left: 5px;">âš ï¸ å¯¼å…¥ä¼šæ¸…ç©ºç°æœ‰æ•°æ®</small>
    </div>

    <div class="main-layout">
        <div>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>èµ„äº§ä½ç½®</th>
                        <th>æ ‡ç­¾</th>
                        <th style="text-align: right;">é‡‘é¢ <small style="color: #64748b; font-weight: normal;">(æ”¯æŒå•ä»·Ã—æ•°é‡)</small></th>
                        <th style="text-align: center;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="dataBody"></tbody>
            </table>
        </div>

        <div style="text-align: center;">
            <h4 style="margin-bottom: 15px;">èµ„é‡‘æ„æˆåˆ†å¸ƒ</h4>
            <canvas id="moneyChart"></canvas>
        </div>
    </div>
</div>

<script>
    let db;
    let chartInstance = null;

    // åˆå§‹åŒ–æ•°æ®åº“
    const req = indexedDB.open("FinanceDB", 1);
    req.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("funds", { keyPath: "id", autoIncrement: true });
    };
    req.onsuccess = e => { 
        db = e.target.result; 
        clearAllData(() => { render(); }); // æ¯æ¬¡æ‰“å¼€æ˜¾ç¤ºç©ºæ•°æ®
    };

    // æ¸…ç©ºæ‰€æœ‰æ•°æ®çš„å‡½æ•°
    function clearAllData(callback) {
        const tx = db.transaction(["funds"], "readwrite");
        const store = tx.objectStore("funds");
        store.clear();
        tx.oncomplete = () => {
            if (callback) callback();
        };
    }

    function saveData() {
        const name = document.getElementById('accName').value;
        const balance = parseFloat(document.getElementById('accBalance').value);
        const price = parseFloat(document.getElementById('accPrice').value) || null;
        const quantity = parseFloat(document.getElementById('accQuantity').value) || null;
        const tag = document.getElementById('accTag').value || "æœªåˆ†ç±»";
        const id = document.getElementById('editId').value;

        if (!name || isNaN(balance)) return alert("è¯·å®Œæ•´å¡«å†™åç§°å’Œé‡‘é¢");

        const tx = db.transaction(["funds"], "readwrite");
        const store = tx.objectStore("funds");
        const record = { name, balance, tag };
        
        // ä¿å­˜å•ä»·å’Œæ•°é‡ä¿¡æ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        if (price && quantity) {
            record.price = price;
            record.quantity = quantity;
        }
        
        if (id) record.id = parseInt(id);

        store.put(record);
        tx.oncomplete = () => { resetForm(); render(); };
    }

    function render() {
        const tx = db.transaction(["funds"], "readonly");
        const store = tx.objectStore("funds");
        store.getAll().onsuccess = e => {
            const data = e.target.result;
            const tbody = document.getElementById('dataBody');
            tbody.innerHTML = '';
            
            let total = 0;
            const stats = {};
            const allTags = new Set();

            data.forEach(item => {
                total += item.balance;
                stats[item.tag] = (stats[item.tag] || 0) + item.balance;
                allTags.add(item.tag);

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${item.name}</strong></td>
                        <td><span class="tag-pill">${item.tag}</span></td>
                        <td class="amt">
                            Â¥ ${item.balance.toLocaleString('zh-CN', {minimumFractionDigits: 2})}
                            ${item.price && item.quantity ? `<br><small style="color: #64748b;">Â¥${item.price} Ã— ${item.quantity}</small>` : ''}
                        </td>
                        <td style="text-align: center;">
                            <button class="btn-edit" onclick="editItem(${item.id})">æ”¹</button>
                            <button class="btn-del" onclick="delItem(${item.id})">åˆ </button>
                        </td>
                    </tr>
                `;
            });

            // æ›´æ–°æ ‡ç­¾ä¸‹æ‹‰é€‰é¡¹
            updateTagOptions(allTags);

            document.getElementById('totalAmount').innerText = `Â¥ ${total.toLocaleString('zh-CN', {minimumFractionDigits: 2})}`;
            updateChart(stats);
        };
    }

    function editItem(id) {
        db.transaction(["funds"]).objectStore("funds").get(id).onsuccess = e => {
            const res = e.target.result;
            document.getElementById('accName').value = res.name;
            document.getElementById('accBalance').value = res.balance;
            document.getElementById('accPrice').value = res.price || '';
            document.getElementById('accQuantity').value = res.quantity || '';
            document.getElementById('accTag').value = res.tag;
            
            // æ ¹æ®æ•°æ®çŠ¶æ€æ›´æ–°è¾“å…¥æ¡†çŠ¶æ€
            updateInputState();
            document.getElementById('editId').value = res.id;
            document.getElementById('saveBtn').innerText = "ç¡®è®¤ä¿®æ”¹";
            document.getElementById('saveBtn').style.background = "#d97706";
        };
    }

    function delItem(id) {
        if(confirm('ç¡®å®šåˆ é™¤è¯¥ç¬”èµ„é‡‘è®°å½•ï¼Ÿ')) {
            const tx = db.transaction(["funds"], "readwrite");
            tx.objectStore("funds").delete(id);
            tx.oncomplete = render;
        }
    }

    function updateTagOptions(allTags) {
        const datalist = document.getElementById('tagList');
        datalist.innerHTML = '';
        
        // å°†æ ‡ç­¾è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
        const sortedTags = Array.from(allTags).sort();
        
        sortedTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            datalist.appendChild(option);
        });
    }

    function updateChart(stats) {
        const ctx = document.getElementById('moneyChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        
        const values = Object.values(stats);
        const total = values.reduce((sum, val) => sum + val, 0);
        
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(stats),
                datasets: [{
                    data: values,
                    backgroundColor: ['#0ea5e9', '#f43f5e', '#10b981', '#f59e0b', '#8b5cf6', '#64748b']
                }]
            },
            options: { 
                cutout: '60%',
                plugins: { 
                    legend: { 
                        position: 'bottom',
                        labels: {
                            generateLabels: function(chart) {
                                const data = chart.data;
                                return data.labels.map((label, index) => {
                                    const value = data.datasets[0].data[index];
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return {
                                        text: `${label}: ${percentage}%`,
                                        fillStyle: data.datasets[0].backgroundColor[index],
                                        hidden: false,
                                        index: index
                                    };
                                });
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                return `${context.label}: Â¥${value.toLocaleString('zh-CN', {minimumFractionDigits: 2})} (${percentage}%)`;
                            }
                        }
                    }
                } 
            }
        });
    }

    async function exportJSON() {
        db.transaction(["funds"]).objectStore("funds").getAll().onsuccess = async e => {
            const data = JSON.stringify(e.target.result, null, 2);
            const time = new Date().toLocaleString().replace(/[\/\s:]/g, '-');
            const filename = `èµ„é‡‘å¤‡ä»½_${time}.json`;
            
            // å°è¯•ä½¿ç”¨File System Access APIä¿å­˜åˆ°ç”¨æˆ·é€‰æ‹©çš„ä½ç½®
            if ('showSaveFilePicker' in window) {
                try {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: 'JSON å¤‡ä»½æ–‡ä»¶',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                    
                    const writable = await fileHandle.createWritable();
                    await writable.write(data);
                    await writable.close();
                    alert('å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¿å­˜åˆ°æ‚¨é€‰æ‹©çš„ä½ç½®ã€‚');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', err);
                        fallbackDownload();
                    }
                }
            } else {
                // å›é€€åˆ°ä¼ ç»Ÿä¸‹è½½æ–¹å¼
                fallbackDownload();
            }
            
            function fallbackDownload() {
                const blob = new Blob([data], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                alert('æ–‡ä»¶å·²ä¸‹è½½åˆ°é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹ã€‚å¦‚éœ€ä¿å­˜åˆ°å…¶ä»–ä½ç½®ï¼Œè¯·æ‰‹åŠ¨ç§»åŠ¨æ–‡ä»¶ã€‚');
            }
        };
    }

    function importJSON(input) {
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                
                // å…ˆæ¸…ç©ºç°æœ‰æ•°æ®ï¼Œå†å¯¼å…¥æ–°æ•°æ®
                clearAllData(() => {
                    const tx = db.transaction(["funds"], "readwrite");
                    
                    data.forEach(d => { 
                        delete d.id; // åˆ é™¤åŸIDï¼Œè®©æ•°æ®åº“è‡ªåŠ¨åˆ†é…æ–°ID
                        tx.objectStore("funds").add(d); 
                    });
                    
                    tx.oncomplete = () => { 
                        alert(`å¯¼å…¥å®Œæˆï¼å·²æ¸…ç©ºåŸæ•°æ®ï¼ŒæˆåŠŸå¯¼å…¥ ${data.length} æ¡æ–°è®°å½•ã€‚`); 
                        render(); 
                    };
                    tx.onerror = () => { 
                        alert("å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–æ•°æ®æ˜¯å¦æœ‰é‡å¤ã€‚"); 
                    };
                });
            } catch (err) {
                alert("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„JSONå¤‡ä»½æ–‡ä»¶ã€‚");
                console.error('è§£æJSONå¤±è´¥:', err);
            }
        };
        reader.readAsText(input.files[0]);
    }

    // å¤„ç†å•ä»·å’Œæ•°é‡çš„è‡ªåŠ¨è®¡ç®—
    function calculateFromPriceAndQuantity() {
        const price = parseFloat(document.getElementById('accPrice').value);
        const quantity = parseFloat(document.getElementById('accQuantity').value);
        const balanceInput = document.getElementById('accBalance');
        
        if (!isNaN(price) && !isNaN(quantity)) {
            balanceInput.value = (price * quantity).toFixed(2);
            balanceInput.disabled = true;
            balanceInput.style.backgroundColor = '#f1f5f9';
        } else {
            updateInputState();
        }
    }
    
    // å¤„ç†é‡‘é¢ç›´æ¥è¾“å…¥æ—¶çš„é€»è¾‘
    function handleBalanceInput() {
        const balanceInput = document.getElementById('accBalance');
        const priceInput = document.getElementById('accPrice');
        const quantityInput = document.getElementById('accQuantity');
        
        if (balanceInput.value) {
            // æ¸…ç©ºå•ä»·å’Œæ•°é‡
            priceInput.value = '';
            quantityInput.value = '';
        }
    }
    
    // æ›´æ–°è¾“å…¥æ¡†çŠ¶æ€
    function updateInputState() {
        const balanceInput = document.getElementById('accBalance');
        const price = parseFloat(document.getElementById('accPrice').value);
        const quantity = parseFloat(document.getElementById('accQuantity').value);
        
        if (isNaN(price) && isNaN(quantity)) {
            balanceInput.disabled = false;
            balanceInput.style.backgroundColor = '';
        }
    }

    function resetForm() {
        document.getElementById('accName').value = '';
        document.getElementById('accBalance').value = '';
        document.getElementById('accPrice').value = '';
        document.getElementById('accQuantity').value = '';
        document.getElementById('accTag').value = '';
        updateInputState();
        document.getElementById('editId').value = '';
        document.getElementById('saveBtn').innerText = "ä¿å­˜è®°å½•";
        document.getElementById('saveBtn').style.background = "#0284c7";
    }

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        updateInputState();
    });

    // æ—¶é—´æ˜¾ç¤º
    setInterval(() => {
        document.getElementById('clock').innerText = "å½“å‰ç³»ç»Ÿæ—¶é—´ï¼š" + new Date().toLocaleString();
    }, 1000);
</script>

</body>
</html>